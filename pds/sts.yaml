apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: pds
spec:
  selector:
    matchLabels:
      app: pds
  serviceName: pds
  replicas: 1
  template:
    metadata:
      labels:
        app: pds
    spec:
      containers:
        - name: pds
          image: ghcr.io/bluesky-social/pds:0.4.193
          ports:
            - containerPort: 2583
              name: http
          env:
            - name: PDS_HOSTNAME
              value: "pds.kentaro1043.com"
            - name: PDS_DATA_DIRECTORY
              value: "/pds/data"
            - name: PDS_BLOBSTORE_DISK_LOCATION
              value: "/pds/blocks"
            - name: PDS_BLOB_UPLOAD_LIMIT
              value: "104857600" # 100MB
            - name: PDS_DID_PLC_URL
              value: "https://plc.directory"
            - name: PDS_BSKY_APP_VIEW_URL
              value: "https://api.bsky.app"
            - name: PDS_BSKY_APP_VIEW_DID
              value: "did:web:api.bsky.app"
            - name: PDS_REPORT_SERVICE_URL
              value: "https://mod.bsky.app"
            - name: PDS_REPORT_SERVICE_DID
              value: "did:plc:ar7c4by46qjdydhdevvrndac"
            - name: PDS_CRAWLERS
              value: "https://bsky.network"
            - name: LOG_ENABLED
              value: "true"
            - name: PDS_EMAIL_FROM_ADDRESS
              value: "service@kentaro1043.com"
          envFrom:
            - secretRef:
                name: pds-secrets
            - secretRef:
                name: smtp-credentials

          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "200m"

          volumeMounts:
            - name: data
              mountPath: /pds/data
            - name: blocks
              mountPath: /pds/blocks
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 1Gi
    - metadata:
        name: blocks
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 1Gi
